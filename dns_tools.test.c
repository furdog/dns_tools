#include "dns_tools.h"

#include <assert.h>
#include <stdio.h>
#include <string.h>

unsigned char sample_query[] = {
	0x71, 0x58, 0x1, 0x0, 0x0, 0x1, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0,
	0x8, 0x61, 0x63, 0x63, 0x6f, 0x75, 0x6e, 0x74, 0x73, 0x7, 0x79, 0x6f, 0x75, 0x74, 0x75, 0x62, 0x65, 0x3, 0x63, 0x6f, 0x6d, 0x0, 0x0, 0x1, 0x0, 0x1};

unsigned char sample_query2[] = {
	0x95, 0x56, 0x81, 0x80, 0x0, 0x1, 0x0, 0x1, 0x0, 0x0, 0x0, 0x0,
	0x5, 0x65, 0x76, 0x65, 0x6e, 0x74, 0xb, 0x73, 0x68, 0x65, 0x6c, 0x6c, 0x6a, 0x61, 0x63, 0x6b, 0x65, 0x74, 0x2, 0x75, 0x73, 0x0, 0x0, 0x1, 0x0, 0x1, 0xc0, 0xc, 0x0, 0x1, 0x0, 0x1, 0x0, 0x0, 0x0, 0xa, 0x0, 0x4, 0x7, 0x7, 0x7, 0x7};

void test_dns_parsing_standard(void)
{
	struct dns_msg msg;
	/* DNS Header (12 bytes) + \003www\006google\003com\000 + Type/Class */
	uint8_t mock_pkt[] = {
		0xab, 0xcd, 0x01, 0x00, 0x00, 0x01, 0x00, 0x00, 
		0x00, 0x00, 0x00, 0x00, /* Header */
		0x03, 'w', 'w', 'w', 
		0x06, 'g', 'o', 'o', 'g', 'l', 'e', 
		0x03, 'c', 'o', 'm', 
		0x00,                   /* Terminator */
		0x00, 0x01, 0x00, 0x01  /* Type A, Class IN */
	};

	dns_msg_init(&msg, mock_pkt, sizeof(mock_pkt));
	dns_msg_parse_query(&msg, sizeof(mock_pkt));

	if (msg.malformed) {
		printf("Test Failed: Packet marked malformed at line %u\n",
			msg.malformed);
		assert(0);
	} else if (strcmp(msg.name, "www.google.com") != 0) {
		printf("Test Failed: Name mismatch: %s\n", msg.name);
		assert(0);
	} else if (msg.query_type != 1) {
		printf("Test Failed: Type mismatch: %u\n", msg.query_type);
		assert(0);
	} else {
		printf("Test Passed: www.google.com parsed correctly\n");
		printf("Type %s\n", dns_msg_get_type_str(&msg));
	}

	dns_msg_init(&msg, sample_query2, sizeof(sample_query2));
	dns_msg_parse_query(&msg, sizeof(sample_query2));

	if (msg.malformed) {
		printf("Test Failed: Packet marked malformed at line %u\n",
			msg.malformed);
		assert(0);
	} else {
		printf("Query | Type: %s | Domain: %s, %u\n",
		dns_msg_get_type_str(&msg), msg.name, msg._name_len);
	}
}

int main(void) {
	test_dns_parsing_standard();

	return 0;
}
